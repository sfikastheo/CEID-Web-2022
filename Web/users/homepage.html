<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>haggle</title>

  <!-- Title icon -->
  <link rel="icon" href="img/location-dot.svg" type="image/x-icon" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
  <!-- MDB -->
  <link rel="stylesheet" href="css/mdb.min.css" />

  <!-- Include Leaflet CSS file in the head section of your html Document -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <!-- Include Leaflet Js file after leaflet's css -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="">
    </script>

</head>

<body style="margin: 0; position: absolute;">
  <!-- First Popper.js, then Bootstrap JS. In case Jquery is used It needs to be loaded first-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <!-- Bootstrap Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">haggle</a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <input class="form-control mr-sm-2" type="search" id="storeSearchBox" placeholder="Search by Store Name"
              aria-label="Search">
          </li>
          <li class="nav-item">
            <input class="form-control mr-sm-2" type="search" id="categorySearchBox"
              placeholder="Search by Product Category" aria-label="Search">
          </li>
        </ul>
        <button class="btn btn-outline-success my-2 my-sm-0" type="button" onclick="storeSearch()">Search</button>
        <button class="btn btn-outline-secondary my-2 my-sm-0" type="button" onclick="categorySearch()">Search</button>
        <button class="btn btn-outline-danger my-2 my-sm-0" type="button" onclick="ResetMap()">Reset</button>
      </div>
    </div>
  </nav>

  <!-- Main content container -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        <!-- Map container -->
        <div id="map" style="height: 90vh;"></div>
      </div>
      <div class="col-md-4">
        <!-- Store info sidebar -->
        <div class="sidebar" id="storeSidebar">
          <div class="sidebar-header">
            <h2 id="storeLabel"></h2>
          </div>
          <div class="sidebar-content" id="storeInfo">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MDB -->
  <script type="text/javascript" src="js/mdb.min.js"></script>

  <!-- Custom scripts -->
  <script type="text/javascript">

    // ============================  Fetch Functions  ============================

    async function fetchAPI(url, method, data = {}) {
      return await fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then(response => response.json())
        .catch(error => {
          console.error(error);
          throw new Error('Something went wrong. Please try again later.');
        });
    }

    // Function to search for stores by name
    function searchStoresByName(storeName) {
      return fetchAPI(`/api/stores/search/${storeName}`, "GET");
    }

    // Function to search for stores by category
    function searchStoresByCategory(categoryId) {
      return fetchAPI(`/api/stores/categories/${categoryId}`, "GET");
    }

    // ============================  Map Functions  ============================

    function gjson_onClick(feature, nameElement, infoElement, storeLabel) {
      nameElement.innerHTML = `<h2>${storeLabel}</h2>`;
      console.log(feature.properties.name);
      let info = fetchAPI(`/api/stores/${feature.properties.id}`);
      info.then((res) => {
        infoElement.innerHTML = JSON.stringify(res);
      });
    }

    function gjson_onEachFeature(feature, layer) {
      let storeLabel = (feature.properties.name == null) ? "Unknown" : feature.properties.name
      layer.on('click', () => { gjson_onClick(feature, storeName, storeInfo, storeLabel); });
      layer.bindPopup(`<h4>${storeLabel}</h4>`, { closeButton: false, offset: L.point(+15, -20) });
      layer.on('mouseover', () => { layer.openPopup(); });
      layer.on('mouseout', () => { layer.closePopup(); });
    }

    function gjson_pointToLayer(feature, latlng) {
      let marker_opacity = (feature.properties.sale_exists) ? 1 : 0.4;
      return L.marker(latlng, {
        opacity: marker_opacity,
        icon: marketIcon
      });
    }

    function gjson_createMarkerLayer(geoJson) {
      let layer = L.geoJSON(geoJson, {
        pointToLayer: gjson_pointToLayer,
        onEachFeature: gjson_onEachFeature
      });
      return layer;
    }

    // Function to reset the map
    function resetMap() {
      // Clear existing filtered markers and re-add all markers
      map.removeLayer(storesFilteredMarkers);
      storesMarkers.addTo(map);
    }

    // ========================= Initialization Functions =========================

    function initializeGeoLocation(userLocation, userMarker) {
      // Initialize geolocation
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          userLocation.lat = position.coords.latitude;
          userLocation.lng = position.coords.longitude;
          userMarker.setLatLng(userLocation);
          map.setView(userLocation, 15);
        });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }


    function initializeEventListeners() {

      // ======================== Initialize Event Listeners ========================
      document.getElementById("storeSearchButton").addEventListener("click", () => {
        const storeName = document.getElementById("storeSearchBox").value;
        searchStoresByName(storeName)
          .then(res => {
            if (res.features && res.features.length > 0) {
              map.removeLayer(storesMarkers);
              storesFilteredMarkers = gjson_createMarkerLayer(res.features);
              storesFilteredMarkers.addTo(map);
            }
          })
          .catch(error => {
            console.error(error);
            alert(error.message);
          });
      });

      document.getElementById("categorySearchButton").addEventListener("click", () => {
        const categoryId = document.getElementById("categorySearchBox").value;
        searchStoresByCategory(categoryId)
          .then(res => {
            if (res.features && res.features.length > 0) {
              map.removeLayer(storesMarkers);
              storesFilteredMarkers = gjson_createMarkerLayer(res.features);
              storesFilteredMarkers.addTo(map);
            }
          })
          .catch(error => {
            console.error(error);
            alert(error.message);
          });
      });

      document.getElementById("resetButton").addEventListener("click", resetMap);

    }

    // ==============================  Execute Logic  ==============================

    // Initialize async variables
    let stores = fetchAPI("/api/stores", "GET");
    let categories = fetchAPI("/api/categories", "GET");

    // Create custom marker icons
    const userIcon = L.icon({
      html: '<i class="fa-solid fa-circle-dot fa-beat"></i>',
      className: 'fa-icon',
      iconSize: [42, 42],
      iconAnchor: [4, 24],
    });

    const marketIcon = L.icon({
      html: '<i class="fa-solid fa-location-dot"></i>',
      className: 'fa-icon',
      iconSize: [38, 38],
      iconAnchor: [4, 24],
    });

    // Initialize map, markers, locations & layers
    const startLocation = { lat: 38.24638, lng: 21.73505 };
    let userLocation = { lat: null, lng: null };
    let userMarker = null, storesMarkers = null, storesFilteredMarkers = null;

    const map = L.map('map').setView(startLocation, 15);
    var OpenStreetMap_HOT = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr/" target="_blank">OpenStreetMap France</a>'
    });
    OpenStreetMap_HOT.addTo(map);

    L.marker(startLocation, { icon: userIcon });

    // ============================== Initialize Map ==============================

    // Initialize geolocation and userMarker
    initializeGeoLocation(userLocation, userMarker);

    // Display initial markers
    stores.then(res => {
      if (res.features) {
        storesMarkers = gjson_createMarkerLayer(res.features);
        storesMarkers.addTo(map);
      }
    });

    // Initialize the app
    initializeEventListeners();

  </script>

</body>

</html>